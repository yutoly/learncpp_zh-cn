8.14 — 使用梅森旋转算法生成随机数  
========================================================

[*作者：Alex*](https://www.learncpp.com/author/Alex/ "查看 Alex 的所有文章")  

2008年12月7日 下午2:43（太平洋标准时间）  
2025年2月2日  

 

 

在上节课[8.13 — 随机数生成简介](Chapter-8/lesson8.13-introduction-to-random-number-generation.md)中，我们介绍了随机数生成的概念，并讨论了如何通过PRNG（伪随机数生成器）算法在程序中模拟随机性。

本课将探讨如何在C++程序中生成随机数。要使用C++的随机化功能，需要包含标准库的`<random>`头文件。

使用梅森旋转算法生成随机数  
----------------  

梅森旋转算法（Mersenne Twister）PRNG不仅名称出众，还是所有编程语言中最流行的PRNG之一。虽然以现代标准来看稍显陈旧，但它通常能产生高质量结果并具备良好性能。C++随机库支持两种梅森旋转算法类型：

* `mt19937`：生成32位无符号整数的梅森旋转算法
* `mt19937_64`：生成64位无符号整数的梅森旋转算法

使用梅森旋转算法非常简单：

```cpp
#include <iostream>
#include <random> // 包含std::mt19937

int main()
{
    std::mt19937 mt{}; // 实例化32位梅森旋转算法引擎

    // 生成40个随机数
    for (int count{ 1 }; count <= 40; ++count)
    {
        std::cout << mt() << '\t'; // 生成随机数

        // 每生成5个数换行
        if (count % 5 == 0)
            std::cout << '\n';
    }

    return 0;
}
```

该程序输出：

```
3499211612      581869302       3890346734      3586334585      545404204
4161255391      3922919429      949333985       2715962298      1323567403
418932835       2350294565      1196140740      809094426       2348838239
4264392720      4112460519      4279768804      4144164697      4156218106
676943009       3117454609      4168664243      4213834039      4111000746
471852626       2084672536      3427838553      3437178460      1275731771
609397212       20544909        1811450929      483031418       3933054126
2747762695      3402504553      3772830893      4120988587      2163214728
```

代码解析：  
1. 包含`<random>`头文件以使用随机数功能  
2. 通过`std::mt19937 mt`实例化32位梅森旋转引擎  
3. 每次调用`mt()`生成32位无符号整数随机数

> **语法说明**  
> `mt()`是`mt.operator()`的简写形式，调用该运算符将返回序列中的下一个随机数。

模拟骰子投掷  
----------------  

32位PRNG生成范围在0-4,294,967,295的随机数，但实际需求往往需要更小范围。通过**随机数分布（random number distribution）**可将PRNG输出转换为目标范围。最常用的是**均匀分布（uniform distribution）**，即在两个数X和Y之间（含边界）等概率生成数值。

以下程序演示6面骰子模拟：

```cpp
#include <iostream>
#include <random> // 包含std::mt19937和std::uniform_int_distribution

int main()
{
    std::mt19937 mt{};

    // 创建生成1-6均匀整数的可重用生成器
    std::uniform_int_distribution die6{ 1, 6 }; // C++14需使用std::uniform_int_distribution<> die6{ 1, 6 };

    for (int count{ 1 }; count <= 40; ++count)
    {
        std::cout << die6(mt) << '\t'; // 生成骰子点数

        if (count % 10 == 0)
            std::cout << '\n';
    }

    return 0;
}
```

输出示例：

```
3       1       3       6       5       2       6       6       1       2
2       6       1       1       6       1       4       5       2       5
6       2       6       2       1       3       5       4       5       6
1       4       2       3       1       2       2       6       2       1
```

关键改进：  
1. 创建`die6`均匀分布对象（范围1-6）  
2. 调用`die6(mt)`生成目标范围随机数

程序随机性缺陷  
----------------  

多次运行上述程序会发现每次输出相同序列，这是因为PRNG使用固定种子初始化。解决方案是使用动态种子：

种子生成方法一：系统时钟  
----------------  

```cpp
#include <chrono> // 包含std::chrono

int main()
{
    // 使用steady_clock为梅森旋转算法生成种子
    std::mt19937 mt{ static_cast<std::mt19937::result_type>(
        std::chrono::steady_clock::now().time_since_epoch().count()
    ) };

    // ...其余代码同上...
}
```

该方法通过`std::chrono::steady_clock`获取当前时间作为种子。不同运行时刻产生不同种子，但快速连续运行可能导致种子相似。

种子生成方法二：随机设备  
----------------  

```cpp
#include <random>

int main()
{
    std::mt19937 mt{ std::random_device{}() }; // 使用随机设备生成种子
    // ...其余代码同上...
}
```

`std::random_device`是系统提供的随机源。注意：需确保编译器正确实现该功能（如GCC 9.2+修复了相关bug）。

> **最佳实践**  
> 优先使用`std::random_device`生成种子（需确认编译器支持）。

PRNG使用规范  
----------------  

* **单次初始化**：每个PRNG对象只应初始化一次  
* **避免重复播种**：重复播种会降低随机性质量  
* **错误示例**：

```cpp
int getCard()
{
    std::mt19937 mt{ std::random_device{}() }; // 错误：每次调用都新建PRNG
    std::uniform_int_distribution card{ 1, 52 };
    return card(mt);
}
```

梅森旋转算法的种子问题  
----------------  

梅森旋转算法的内部状态需要624个32位整数。使用单个整数播种会导致**欠播种（underseeding）**。解决方案：

```cpp
#include <random>

int main()
{
    std::random_device rd{};
    std::seed_seq ss{ rd(), rd(), rd(), rd(), rd(), rd(), rd(), rd() }; // 获取8个随机数
    std::mt19937 mt{ ss }; // 使用种子序列初始化

    // ...其余代码同上...
}
```

`std::seed_seq`可根据提供的种子生成更多初始化值，改善播种质量。推荐至少提供8个随机数。

调试技巧  
----------------  

* **固定种子调试**：使用固定种子（如`5`）复现错误  
* **错误排查**：  
  - 相同随机序列：未正确播种  
  - 重复相同数值：在生成随机数前重复播种或创建新PRNG

随机数FAQ  
----------------  

**问**：为何每次生成相同序列？  
答：未正确播种，确保使用动态种子（如系统时钟或随机设备）。

**问**：为何总是生成相同数值？  
答：可能在每次生成前重新播种或创建新PRNG对象。

[下一课 8.15 全局随机数（Random.h）](Chapter-8/lesson8.15-global-random-numbers-random-h.md)  
[返回主页](/)  
[  
[上一课 8.13 随机数生成简介](Chapter-8/lesson8.13-introduction-to-random-number-generation.md)