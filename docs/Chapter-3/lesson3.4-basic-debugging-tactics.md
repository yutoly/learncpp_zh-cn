3.4 — 基础调试策略  
================================================

[*作者：Alex*](https://www.learncpp.com/author/Alex/ "查看 Alex 的所有文章")  
2024年12月30日（首次发布于2019年2月1日）  

本章导读  
----------------  

上节课我们探讨了通过运行程序和使用推测来定位问题的策略。本节我们将学习实际进行推测和收集信息以定位问题的基本调试技巧。  

调试策略一：注释代码  
----------------  

当程序出现异常行为时，可以通过注释部分代码来缩小排查范围。如果问题依然存在，被注释的代码可能不是问题根源。  

示例代码：  

```cpp
int main()
{
    getNames(); // 让用户输入一系列名字
    doMaintenance(); // 执行随机维护任务
    sortNames(); // 按字母顺序排序
    printNames(); // 打印排序后的名单
    return 0;
}
```  

假设程序将名字逆序输出，注释`doMaintenance()`后可能出现三种情况：  

1. 问题消失 → `doMaintenance()`是问题根源  
2. 问题依旧 → 排除该函数  
3. 出现新问题 → 该函数可能被其他代码依赖  

> **警告**  
> 务必记录注释过的代码，调试完成后及时恢复。使用版本控制系统（如Git）可有效追踪修改。  

> **技巧**  
> 可使用第三方库（如[dbg](https://github.com/sharkdp/dbg-macro)）通过预处理器宏管理调试语句，在发布版本中自动移除调试代码。  

调试策略二：验证代码流程  
----------------  

在复杂程序中，函数可能被错误调用（次数过多或过少）。通过在函数入口添加输出语句可追踪调用情况：  

```cpp
#include <iostream>

int getValue()
{
    std::cerr << "getValue()被调用\n"; // 使用cerr确保实时输出
    return 4;
}

int main()
{
    std::cerr << "main()被调用\n";
    std::cout << getValue << '\n'; // 错误：遗漏括号
    return 0;
}
```  

输出结果：  

```
main()被调用
1
```  

通过调试输出可发现`getValue()`未被调用，进而发现函数调用遗漏括号的问题。  

> **格式提示**  
> 临时调试语句可不缩进以便后续查找。使用`// clang-format off`可禁用代码格式化工具对调试语句的影响。  

调试策略三：输出变量值  
----------------  

当程序计算或传递错误值时，输出变量和表达式值可快速定位问题：  

错误示例程序：  

```cpp
int add(int x, int y) { return x + y; }

int main()
{
    int x{ getUserInput() }; // 输入4
    int y{ getUserInput() }; // 输入3
    int z{ add(x, 5) };      // 错误：硬编码5而非y
    printResult(z);          // 输出9
    return 0;
}
```  

添加调试语句后：  

```cpp
std::cerr << "main::x = " << x << '\n'; // 输出4
std::cerr << "main::y = " << y << '\n'; // 输出3
std::cerr << "add()参数 (x=" << x << ", y=5)\n"; // 暴露错误参数
```  

通过输出可发现`add()`函数的第二个参数错误传递了字面量5。  

调试语句的局限性  
----------------  

1. 使代码臃肿  
2. 污染程序输出  
3. 增删调试代码可能引入新错误  
4. 不可重复使用  

后续课程将介绍更高效的调试方法。  

[下一课 3.5 — 进阶调试策略](Chapter-3/lesson3.5-more-debugging-tactics.md)  
[返回主页](/)  
[上一课 3.3 — 调试策略](Chapter-3/lesson3.3-a-strategy-for-debugging.md)